

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Pandas &mdash; EveryThing 2.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Python" href="../Snippet/python.html" />
    <link rel="prev" title="Scientific Plots" href="50_plots.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> EveryThing
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">SNA</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="10_sphinx_rst.html">Sphinx</a></li>
<li class="toctree-l1"><a class="reference internal" href="30_gee.html">GEE</a></li>
<li class="toctree-l1"><a class="reference internal" href="50_plots.html">Scientific Plots</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Pandas</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#genertate-df">Genertate DF</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-data-frame">Create Data Frame</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-frames-for-testing">Data Frames For Testing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#table-processing">Table Processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configure-pandas">Configure Pandas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-frame-formatting">Data Frame Formatting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lower-case-columns">Lower Case Columns</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fast-data-frame-split">Fast Data Frame Split</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-features-and-labels-list">Create Features and Labels List</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gallery">Gallery</a></li>
<li class="toctree-l3"><a class="reference internal" href="#read-commands">Read Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-ordered-categories">Create Ordered Categories</a></li>
<li class="toctree-l3"><a class="reference internal" href="#select-columns-based-on-regex">Select Columns Based on Regex</a></li>
<li class="toctree-l3"><a class="reference internal" href="#accessing-group-of-groupby-object">Accessing Group of Groupby Object</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiple-external-selection-criteria">Multiple External Selection Criteria</a></li>
<li class="toctree-l3"><a class="reference internal" href="#memory-reduction-script-func">Memory Reduction Script (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#verify-primary-key-func">Verify Primary Key (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shift-columns-to-front-func">Shift Columns to Front (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiple-column-assignments">Multiple Column Assignments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#method-chaining-technique">Method Chaining Technique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#load-multiple-files">Load Multiple Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#drop-rows-with-column-substring">Drop Rows with Column Substring</a></li>
<li class="toctree-l3"><a class="reference internal" href="#unnest-explode-a-column">Unnest (Explode) a Column</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nest-list-back-into-column">Nest List Back into Column</a></li>
<li class="toctree-l3"><a class="reference internal" href="#split-cells-with-lists">Split Cells With Lists</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#table-exploration">Table Exploration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#groupby-functionality">Groupby Functionality</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cross-correlation-series-without-duplicates-func">Cross Correlation Series Without Duplicates (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#missing-data-report">Missing Data Report</a></li>
<li class="toctree-l3"><a class="reference internal" href="#duplicated-rows-report">Duplicated Rows Report</a></li>
<li class="toctree-l3"><a class="reference internal" href="#skewness-func">Skewness (func)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#feature-processing">Feature Processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#remove-correlated-pairs-func">Remove Correlated Pairs (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#replace-infrequently-occuring-categories">Replace Infrequently Occuring Categories</a></li>
<li class="toctree-l3"><a class="reference internal" href="#quasi-constant-features-detection-func">Quasi-Constant Features Detection (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filling-missing-values-separately">Filling Missing Values Separately</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conditioned-column-value-replacement">Conditioned Column Value Replacement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#remove-non-numeric-values-in-data-frame">Remove Non-numeric Values in Data Frame</a></li>
<li class="toctree-l3"><a class="reference internal" href="#feature-scaling-normalisation-standardisation-func">Feature Scaling, Normalisation, Standardisation (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#impute-null-with-tail-distribution-func">Impute Null with Tail Distribution (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#detect-outliers-func">Detect Outliers (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#windsorize-outliers-func">Windsorize Outliers (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#drop-outliers">Drop Outliers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#impute-outliers">Impute Outliers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#feature-engineering">Feature Engineering</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#automated-dummy-one-hot-encoding-func">Automated Dummy (one-hot) Encoding(func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#binarise-empty-columns-func">Binarise Empty Columns (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#polynomials-func">Polynomials (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transformations-func">Transformations (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#genetic-programming">Genetic Programming</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prinicipal-component-features-func">Prinicipal Component Features (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiple-lags-func">Multiple Lags (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiple-rolling-func">Multiple Rolling (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#date-features">Date Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#haversine-distance-location-feature-func">Haversine Distance (Location Feature) (func)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parse-address">Parse Address</a></li>
<li class="toctree-l3"><a class="reference internal" href="#processing-strings-in-pandas">Processing Strings in Pandas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filtering-strings-in-pandas">Filtering Strings in Pandas</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#model-validation">Model Validation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#classification-metrics-func">Classification Metrics (func)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Snippet/python.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Snippet/R.html">R</a></li>
</ul>
<p class="caption"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../1_Notes/10_notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Notes/10_notes.html#methods">Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Notes/10_notes.html#data">Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Discussion</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../2_DIS/11_debate.html">辩行记</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_DIS/12_articles.html">Articles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_DIS/13_libretto.html">Libretto</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">EveryThing</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Pandas</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/0_SNA/51_pandas.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="pandas">
<h1>Pandas<a class="headerlink" href="#pandas" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://github.com/firmai/pandasvault#table-processing">https://github.com/firmai/pandasvault#table-processing</a></p>
<div class="section" id="genertate-df">
<h2>Genertate DF<a class="headerlink" href="#genertate-df" title="Permalink to this headline">¶</a></h2>
<div class="section" id="create-data-frame">
<h3>Create Data Frame<a class="headerlink" href="#create-data-frame" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;quick way to create a data frame for testing&quot;&quot;&quot;</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">])</span> \
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="data-frames-for-testing">
<h3>Data Frames For Testing<a class="headerlink" href="#data-frames-for-testing" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas.util.testing</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">makeDataFrame</span><span class="p">()</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">makeMissingDataframe</span><span class="p">()</span> <span class="c1"># contains missing values</span>
<span class="n">df3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">makeTimeDataFrame</span><span class="p">()</span> <span class="c1"># contains datetime values</span>
<span class="n">df4</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">makeMixedDataFrame</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="table-processing">
<h2>Table Processing<a class="headerlink" href="#table-processing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="configure-pandas">
<h3>Configure Pandas<a class="headerlink" href="#configure-pandas" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">##https://pandas.pydata.org/pandas-docs/stable/user_guide/options.html</span>
<span class="k">def</span> <span class="nf">pd_config</span><span class="p">():</span>
    <span class="n">options</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;display&quot;</span><span class="p">:{</span>
            <span class="s1">&#39;max_colwidth&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="c1">## 每一格行宽度</span>
            <span class="s2">&quot;max_columns&quot;</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span>
            <span class="s1">&#39;expand_frame_repr&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># wrap to multiple pages</span>
            <span class="s1">&#39;max_rows&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
            <span class="s1">&#39;max_seq_items&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>         <span class="c1"># Max length of printed sequence</span>
            <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>               <span class="c1"># 小数精度</span>
            <span class="s1">&#39;show_dimensions&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>    <span class="c1">#显示行列</span>
            <span class="s2">&quot;large_repr&quot;</span><span class="p">:</span><span class="s2">&quot;truncate&quot;</span><span class="p">,</span><span class="c1">#&quot;info&quot; show as summary of df</span>
            <span class="s2">&quot;unicode.east_asian_width&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># true to show east word in same length but in a longer time</span>
            <span class="s2">&quot;date_dayfirst&quot;</span><span class="p">:</span><span class="kc">True</span> <span class="c1"># 20/01/2005 false:2005/01/20</span>
        <span class="p">},</span>
        <span class="s2">&quot;mode&quot;</span><span class="p">:{</span>
            <span class="s1">&#39;chained_assignment&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;use_inf_as_na&quot;</span><span class="p">:</span><span class="kc">False</span> <span class="c1">#True means treat None, NaN, -INF, INF as NA (old way), False means None and NaN are null, but INF, -INF are not NA (new way).</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">option</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{category}</span><span class="s1">.</span><span class="si">{op}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># Python 3.6+</span>
<span class="c1">## pd.reset_option(&quot;^display&quot;)## 复原</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="data-frame-formatting">
<h3>Data Frame Formatting<a class="headerlink" href="#data-frame-formatting" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="p">(</span>
<span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span><span class="s2">&quot;$</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span><span class="s2">&quot;$</span><span class="si">{:.5f}</span><span class="s2">&quot;</span><span class="p">})</span>
<span class="o">.</span><span class="n">hide_index</span><span class="p">()</span>
<span class="o">.</span><span class="n">highlight_min</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="o">.</span><span class="n">highlight_max</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
<span class="o">.</span><span class="n">background_gradient</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
<span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;lightblue&quot;</span><span class="p">,</span> <span class="n">align</span> <span class="o">=</span> <span class="s2">&quot;zero&quot;</span><span class="p">)</span>
<span class="o">.</span><span class="n">set_caption</span><span class="p">(</span><span class="s2">&quot;DF with different stylings&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
<img alt="../_images/df_formatting.jpg" src="../_images/df_formatting.jpg" />
</div>
<div class="section" id="lower-case-columns">
<h3>Lower Case Columns<a class="headerlink" href="#lower-case-columns" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span><span class="s2">&quot;BGs&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">,</span><span class="s2">&quot;dag&quot;</span><span class="p">,</span><span class="s2">&quot;Target&quot;</span><span class="p">]</span><span class="c1">#df.columns.to_list()</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="fast-data-frame-split">
<h3>Fast Data Frame Split<a class="headerlink" href="#fast-data-frame-split" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">test</span> <span class="o">=</span>  <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span> <span class="c1">## sample</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">test</span><span class="p">)]</span><span class="o">.</span><span class="n">dropna</span><span class="p">();</span> <span class="n">train</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="create-features-and-labels-list">
<h3>Create Features and Labels List<a class="headerlink" href="#create-features-and-labels-list" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">## 选择除A之外的列名</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="gallery">
<h3>Gallery<a class="headerlink" href="#gallery" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>  <span class="s2">&quot;0&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;set display width, col_width etc for interactive pandas session&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_colwidth&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;when you have an excel sheet with spaces in column names&quot;&quot;&quot;</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

<span class="sd">&quot;&quot;&quot;Add prefix to all columns&quot;&quot;&quot;</span>
<span class="n">df</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;1_&quot;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;Add suffix to all columns&quot;&quot;&quot;</span>
<span class="n">df</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s2">&quot;_Z&quot;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;Droping column where missing values are above a threshold&quot;&quot;&quot;</span>
<span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">thresh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="s2">&quot;columns&quot;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;Given a dataframe df to filter by a series [&quot;a&quot;,&quot;b&quot;]:&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="s2">&quot;0&quot;</span><span class="p">])]</span>

<span class="sd">&quot;&quot;&quot;filter by multiple conditions in a dataframe df&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">&lt;</span><span class="mi">1</span><span class="p">)]</span>

<span class="sd">&quot;&quot;&quot;filter by conditions and the condition on row labels(index)&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))]</span>

<span class="sd">&quot;&quot;&quot;regexp filters on strings (vectorized), use .* instead of *&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*[0-9].*&#39;</span><span class="p">)]</span>

<span class="sd">&quot;&quot;&quot;logical NOT is like this&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*[0-9].*&#39;</span><span class="p">)]</span>

<span class="sd">&quot;&quot;&quot;creating complex filters using functions on rows&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

<span class="sd">&quot;&quot;&quot;Pandas replace operation&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mf">0.87</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">][</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">19</span>

<span class="sd">&quot;&quot;&quot;Conditionals and selectors&quot;&quot;&quot;</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;target&quot;</span><span class="p">]]</span>

<span class="sd">&quot;&quot;&quot;Selecting multiple column slices&quot;&quot;&quot;</span>
<span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]]</span>

<span class="sd">&quot;&quot;&quot;apply and map examples&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;add 2 to row 3 and return the series&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;add 3 to col A and return the series&quot;&quot;&quot;</span>
<span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot; Split delimited values in a DataFrame column into two new columns &quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;new1&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;new2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

<span class="sd">&quot;&quot;&quot; Doing calculations with DataFrame columns that have missing values</span>
<span class="sd">In example below, swap in 0 for df[&#39;col1&#39;] cells that contain null &quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;new3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]),</span><span class="mi">0</span><span class="p">,</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>

<span class="sd">&quot;&quot;&quot; Exclude certain data type or include certain data types &quot;&quot;&quot;</span>
<span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;O&#39;</span><span class="p">,</span><span class="s1">&#39;float&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">])</span>

<span class="sd">&quot;&quot;&quot;one liner to normalize a data frame&quot;&quot;&quot;</span>
<span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

<span class="sd">&quot;&quot;&quot;groupby used like a histogram to obtain counts on sub-ranges of a variable, pretty handy&quot;&quot;&quot;</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

<span class="sd">&quot;&quot;&quot;use a local variable use inside a query of pandas using @&quot;&quot;&quot;</span>
<span class="n">mean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;a &gt; @mean&quot;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;Calculate the % of missing values in each column&quot;&quot;&quot;</span>
<span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="sd">&quot;&quot;&quot;Calculate the % of missing values in each row&quot;&quot;&quot;</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span> <span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="read-commands">
<h3>Read Commands<a class="headerlink" href="#read-commands" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;To avoid Unnamed: 0 when loading a previously saved csv with index&quot;&quot;&quot;</span>
<span class="sd">&quot;&quot;&quot;To parse dates&quot;&quot;&quot;</span>
<span class="sd">&quot;&quot;&quot;To set data types&quot;&quot;&quot;</span>

<span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span><span class="s2">&quot;int64&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;Copy data to clipboard; like an excel copy and paste</span>
<span class="sd">df = pd.read_clipboard()</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;Read table from website</span>
<span class="sd">df = pd.read_html(url, match=&quot;table_name&quot;)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot; Read pdf into dataframe ()</span>
<span class="sd">!pip install tabula</span>
<span class="sd">from tabula import read_pdf</span>
<span class="sd">df = read_pdf(&#39;test.pdf&#39;, pages=&#39;all&#39;)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">df_out</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="create-ordered-categories">
<h3>Create Ordered Categories<a class="headerlink" href="#create-ordered-categories" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;cats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bad&quot;</span><span class="p">,</span><span class="s2">&quot;good&quot;</span><span class="p">,</span><span class="s2">&quot;excellent&quot;</span><span class="p">]</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">CategoricalDtype</span>

<span class="c1">## Let&#39;s create our own categorical order.</span>
<span class="n">cat_type</span> <span class="o">=</span> <span class="n">CategoricalDtype</span><span class="p">([</span><span class="s2">&quot;bad&quot;</span><span class="p">,</span> <span class="s2">&quot;good&quot;</span><span class="p">,</span> <span class="s2">&quot;excellent&quot;</span><span class="p">],</span> <span class="n">ordered</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;cats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">cat_type</span><span class="p">)</span>

<span class="c1">## Now we can use logical sorting.</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;cats&quot;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1">## We can also filter this as if they are numbers.</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;cats&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="s2">&quot;bad&quot;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="select-columns-based-on-regex">
<h3>Select Columns Based on Regex<a class="headerlink" href="#select-columns-based-on-regex" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.filter.html</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s2">&quot;_l&quot;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># items : Keep labels from axis which are in items.</span>
<span class="c1"># like ：Keep labels from axis for which “like in label == True”.</span>
<span class="c1"># regex :</span>
<span class="c1"># axis : 0 rows 1 columns</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="accessing-group-of-groupby-object">
<h3>Accessing Group of Groupby Object<a class="headerlink" href="#accessing-group-of-groupby-object" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;groupie&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;falcon&quot;</span><span class="p">,</span><span class="s2">&quot;hawk&quot;</span><span class="p">,</span><span class="s2">&quot;hawk&quot;</span><span class="p">,</span><span class="s2">&quot;eagle&quot;</span><span class="p">,</span><span class="s2">&quot;falcon&quot;</span><span class="p">,</span><span class="s2">&quot;hawk&quot;</span><span class="p">]</span>
<span class="n">gbdf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;groupie&quot;</span><span class="p">)</span>
<span class="n">hawk</span> <span class="o">=</span> <span class="n">gbdf</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="s2">&quot;hawk&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="multiple-external-selection-criteria">
<h3>Multiple External Selection Criteria<a class="headerlink" href="#multiple-external-selection-criteria" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">cr1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="n">cr2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
<span class="n">cr3</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="n">cr4</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span> <span class="o">&gt;-</span><span class="mi">1</span>
<span class="n">df</span><span class="p">[</span><span class="n">cr1</span> <span class="o">&amp;</span> <span class="n">cr2</span> <span class="o">&amp;</span> <span class="n">cr3</span> <span class="o">&amp;</span> <span class="n">cr4</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="memory-reduction-script-func">
<h3>Memory Reduction Script (func)<a class="headerlink" href="#memory-reduction-script-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gc</span>
<span class="k">def</span> <span class="nf">reduce_mem_usage</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; iterate through all the columns of a dataframe and modify the data type</span>
<span class="sd">        to reduce memory usage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_mem</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Memory usage of dataframe is </span><span class="si">{:.2f}</span><span class="s1"> MB&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_mem</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">col_type</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">col_type</span> <span class="o">!=</span> <span class="nb">object</span><span class="p">:</span>
            <span class="n">c_min</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">c_max</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_type</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

    <span class="n">end_mem</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Memory usage after optimization is: </span><span class="si">{:.2f}</span><span class="s1"> MB&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end_mem</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Decreased by </span><span class="si">{:.1f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">start_mem</span> <span class="o">-</span> <span class="n">end_mem</span><span class="p">)</span> <span class="o">/</span> <span class="n">start_mem</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">df</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">reduce_mem_usage</span><span class="p">(</span><span class="n">df</span><span class="p">);</span> <span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="verify-primary-key-func">
<h3>Verify Primary Key (func)<a class="headerlink" href="#verify-primary-key-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;first_d&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;second_d&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">verify_primary_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">column_list</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">verify_primary_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;first_d&quot;</span><span class="p">,</span><span class="s2">&quot;second_d&quot;</span><span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="shift-columns-to-front-func">
<h3>Shift Columns to Front (func)<a class="headerlink" href="#shift-columns-to-front-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">list_shuff</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="s2">&quot;Bring a list of columns to the front&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)):</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cols</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df_out</span> <span class="o">=</span> <span class="n">list_shuff</span><span class="p">([</span><span class="s2">&quot;target&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">,</span><span class="s2">&quot;d&quot;</span><span class="p">],</span><span class="n">df</span><span class="p">);</span> <span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="multiple-column-assignments">
<h3>Multiple Column Assignments<a class="headerlink" href="#multiple-column-assignments" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stringed</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
        <span class="n">ounces</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">12</span><span class="p">,</span><span class="c1">#    this will allow yo set a title</span>
        <span class="n">galons</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">128</span><span class="p">)</span>
       <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;b &gt; -1&quot;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_caption</span><span class="p">(</span><span class="s2">&quot;Average consumption&quot;</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="method-chaining-technique">
<h3>Method Chaining Technique<a class="headerlink" href="#method-chaining-technique" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">&gt;</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span>  <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># with line continuation character</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">],</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span> \
<span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> \
<span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> \
<span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;target&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> \
<span class="o">.</span><span class="n">unstack</span><span class="p">()</span> \
<span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> \
<span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> \
<span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> \
<span class="o">.</span><span class="n">stack</span><span class="p">()</span> \
<span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span>
<span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="load-multiple-files">
<h3>Load Multiple Files<a class="headerlink" href="#load-multiple-files" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;folder&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,);</span> <span class="n">df_test</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;folder/first.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">;</span> <span class="n">df_test</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;folder/last.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;folder/*.csv&#39;</span><span class="p">)</span>
<span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="drop-rows-with-column-substring">
<h3>Drop Rows with Column Substring<a class="headerlink" href="#drop-rows-with-column-substring" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;string_feature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1xZoo&quot;</span><span class="p">,</span> <span class="s2">&quot;Safe7x&quot;</span><span class="p">,</span> <span class="s2">&quot;bat4&quot;</span><span class="p">]</span>
<span class="n">substring</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xZ&quot;</span><span class="p">,</span><span class="s2">&quot;7z&quot;</span><span class="p">,</span> <span class="s2">&quot;tab4&quot;</span><span class="p">]</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">string_feature</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">substring</span><span class="p">))]</span>
<span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="unnest-explode-a-column">
<h3>Unnest (Explode) a Column<a class="headerlink" href="#unnest-explode-a-column" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">+</span><span class="n">lista</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span> <span class="k">for</span> <span class="n">lista</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">]]</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">);</span> <span class="n">df_out</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">,:]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="nest-list-back-into-column">
<h3>Nest List Back into Column<a class="headerlink" href="#nest-list-back-into-column" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">### Run above example first</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_out</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_out</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_out</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df_out</span><span class="o">.</span><span class="n">index</span><span class="p">)[</span><span class="s1">&#39;g&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">df_out</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="split-cells-with-lists">
<h3>Split Cells With Lists<a class="headerlink" href="#split-cells-with-lists" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">+</span><span class="n">lista</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)])</span> <span class="k">for</span> <span class="n">lista</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">]]</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">g</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="table-exploration">
<h2>Table Exploration<a class="headerlink" href="#table-exploration" title="Permalink to this headline">¶</a></h2>
<div class="section" id="groupby-functionality">
<h3>Groupby Functionality<a class="headerlink" href="#groupby-functionality" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;gr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;gr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">])</span>
<span class="n">df_out</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,:]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="cross-correlation-series-without-duplicates-func">
<h3>Cross Correlation Series Without Duplicates (func)<a class="headerlink" href="#cross-correlation-series-without-duplicates-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">corr_list</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>

    <span class="k">return</span>  <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
            <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;quicksort&quot;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]);</span> <span class="n">df_out</span>

<span class="n">corr_list</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="missing-data-report">
<h3>Missing Data Report<a class="headerlink" href="#missing-data-report" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">&gt;</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span>  <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">missing_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="s2">&quot;Create a dataframe with a percentage and count of missing values&quot;</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">total</span><span class="p">,</span> <span class="n">percent</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="s1">&#39;Percent&#39;</span><span class="p">])</span>

<span class="n">df_out</span> <span class="o">=</span> <span class="n">missing_data</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="duplicated-rows-report">
<h3>Duplicated Rows Report<a class="headerlink" href="#duplicated-rows-report" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># Get a report of all duplicate records in a dataframe, based on specific columns</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="skewness-func">
<h3>Skewness (func)<a class="headerlink" href="#skewness-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">skew</span>

<span class="k">def</span> <span class="nf">display_skewness</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;show skewness information</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: pandas dataframe</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        df: pandas dataframe</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">!=</span> <span class="s1">&#39;object&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">skew_value</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">:</span>
        <span class="n">skew_value</span> <span class="o">+=</span> <span class="p">[</span><span class="n">skew</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">numeric_cols</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">!=</span> <span class="s1">&#39;object&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">skew_value</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">,</span> <span class="s1">&#39;col_type&#39;</span><span class="p">,</span> <span class="s1">&#39;skew_value&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">df</span>

<span class="n">display_skewness</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="feature-processing">
<h2>Feature Processing<a class="headerlink" href="#feature-processing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="remove-correlated-pairs-func">
<h3>Remove Correlated Pairs (func)<a class="headerlink" href="#remove-correlated-pairs-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span> <span class="n">df</span>
<span class="k">def</span> <span class="nf">drop_corr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span><span class="n">keep_cols</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">df_corr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">df_corr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">df_corr</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">))</span>
    <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">upper</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">upper</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">)]</span> <span class="c1">## Change to 99% for selection</span>
    <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">to_remove</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_cols</span><span class="p">]</span>
    <span class="n">df_corr</span> <span class="o">=</span> <span class="n">df_corr</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">to_remove</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">to_remove</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">df_out</span> <span class="o">=</span> <span class="n">drop_corr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">keep_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]);</span> <span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="replace-infrequently-occuring-categories">
<h3>Replace Infrequently Occuring Categories<a class="headerlink" href="#replace-infrequently-occuring-categories" title="Permalink to this headline">¶</a></h3>
<p>替换频率比较小的类别</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">df</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;cat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bat&quot;</span><span class="p">,</span><span class="s2">&quot;bat&quot;</span><span class="p">,</span><span class="s2">&quot;rat&quot;</span><span class="p">,</span><span class="s2">&quot;mat&quot;</span><span class="p">,</span><span class="s2">&quot;mat&quot;</span><span class="p">,</span><span class="s2">&quot;mat&quot;</span><span class="p">,</span><span class="s2">&quot;mat&quot;</span><span class="p">,</span><span class="s2">&quot;mat&quot;</span><span class="p">,</span><span class="s2">&quot;mat&quot;</span><span class="p">];</span> <span class="n">df</span>
<span class="k">def</span> <span class="nf">replace_small_cat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="s2">&quot;other&quot;</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="c1"># Step 1: count the frequencies</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Step 2: establish your threshold and filter the smaller categories</span>
        <span class="n">small_categories</span> <span class="o">=</span> <span class="n">frequencies</span><span class="p">[</span><span class="n">frequencies</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">small_categories</span><span class="p">,</span> <span class="s2">&quot;Other&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">replace_small_cat</span><span class="p">(</span><span class="n">df</span><span class="p">,[</span><span class="s2">&quot;cat&quot;</span><span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="quasi-constant-features-detection-func">
<h3>Quasi-Constant Features Detection (func)<a class="headerlink" href="#quasi-constant-features-detection-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="k">def</span> <span class="nf">constant_feature_detect</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.98</span><span class="p">):</span>
    <span class="n">data_copy</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    <span class="c1">#if False Any changes to the data of the original will be reflected in the shallow copy</span>
    <span class="n">quasi_constant_feature</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">predominant</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_copy</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">data_copy</span><span class="p">)))</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">predominant</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">quasi_constant_feature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">quasi_constant_feature</span>

<span class="c1"># the original dataset has no constant variable</span>
<span class="n">qconstant_col</span> <span class="o">=</span> <span class="n">constant_feature_detect</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">qconstant_col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span> <span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="filling-missing-values-separately">
<h3>Filling Missing Values Separately<a class="headerlink" href="#filling-missing-values-separately" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">&gt;</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span>  <span class="o">=</span> <span class="kc">None</span>
<span class="c1"># Clean up missing values in multiple DataFrame columns</span>
<span class="n">dict_fill</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="mi">9999</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s2">&quot;False&quot;</span><span class="p">}</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">dict_fill</span><span class="p">)</span> <span class="p">;</span><span class="n">df</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="conditioned-column-value-replacement">
<h3>Conditioned Column Value Replacement<a class="headerlink" href="#conditioned-column-value-replacement" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># Set DataFrame column values based on other column values</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">&gt;</span><span class="mi">1</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="remove-non-numeric-values-in-data-frame">
<h3>Remove Non-numeric Values in Data Frame<a class="headerlink" href="#remove-non-numeric-values-in-data-frame" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;SC&quot;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TI4560L&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[^0-9]+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="feature-scaling-normalisation-standardisation-func">
<h3>Feature Scaling, Normalisation, Standardisation (func)<a class="headerlink" href="#feature-scaling-normalisation-standardisation-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>

<span class="k">def</span> <span class="nf">scaler</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cols_ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Standard&quot;</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">cols_ignore</span><span class="p">:</span>
        <span class="n">hold</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols_ignore</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cols_ignore</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">target</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="c1">#returns a numpy array</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">train</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="o">==</span><span class="s2">&quot;Standard&quot;</span><span class="p">:</span>
        <span class="n">scal</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="o">==</span><span class="s2">&quot;MinMax&quot;</span><span class="p">:</span>
        <span class="n">scal</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
        <span class="n">scal</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x_scaled</span> <span class="o">=</span> <span class="n">scal</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">target</span><span class="p">:</span>
        <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x_scaled</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">target</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">df_out</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x_scaled</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">hold</span><span class="p">,</span><span class="n">df_out</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">train</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df_out</span><span class="p">,</span> <span class="n">scal</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df_out</span>

<span class="n">df_out_train</span><span class="p">,</span> <span class="n">scl</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">target</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span><span class="n">cols_ignore</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;MinMax&quot;</span><span class="p">)</span>
<span class="n">df_out_test</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span><span class="n">scaler</span><span class="o">=</span><span class="n">scl</span><span class="p">,</span><span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span><span class="n">cols_ignore</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="impute-null-with-tail-distribution-func">
<h3>Impute Null with Tail Distribution (func)<a class="headerlink" href="#impute-null-with-tail-distribution-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">&gt;</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span>  <span class="o">=</span> <span class="kc">None</span>
<span class="k">def</span> <span class="nf">impute_null_with_tail</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    replacing the NA by values that are at the far end of the distribution of that variable</span>
<span class="sd">    calculated by mean + 3*std</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Column </span><span class="si">%s</span><span class="s2"> has no missing&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df_out</span> <span class="o">=</span> <span class="n">impute_null_with_tail</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">);</span> <span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="detect-outliers-func">
<h3>Detect Outliers (func)<a class="headerlink" href="#detect-outliers-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">outlier_detect</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;IQR&quot;</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;IQR&quot;</span><span class="p">:</span>
        <span class="n">IQR</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="n">Lower_fence</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">IQR</span> <span class="o">*</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="n">Upper_fence</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">IQR</span> <span class="o">*</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;STD&quot;</span><span class="p">:</span>
        <span class="n">Upper_fence</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">Lower_fence</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;OWN&quot;</span><span class="p">:</span>
        <span class="n">Upper_fence</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">Lower_fence</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span><span class="s2">&quot;MAD&quot;</span><span class="p">:</span>
        <span class="n">median</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="n">median_absolute_deviation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]])</span>
        <span class="n">modified_z_scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mf">0.6745</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span> <span class="o">/</span> <span class="n">median_absolute_deviation</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]])</span>
        <span class="n">outlier_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">modified_z_scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Num of outlier detected:&#39;</span><span class="p">,</span><span class="n">outlier_index</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Proportion of outlier detected&#39;</span><span class="p">,</span><span class="n">outlier_index</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">outlier_index</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">outlier_index</span><span class="p">,</span> <span class="p">(</span><span class="n">median_absolute_deviation</span><span class="p">,</span> <span class="n">median_absolute_deviation</span><span class="p">)</span>


    <span class="n">para</span> <span class="o">=</span> <span class="p">(</span><span class="n">Upper_fence</span><span class="p">,</span> <span class="n">Lower_fence</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">&gt;</span><span class="n">Upper_fence</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">&lt;</span><span class="n">Lower_fence</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">outlier_index</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Num of outlier detected:&#39;</span><span class="p">,</span><span class="n">outlier_index</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Proportion of outlier detected&#39;</span><span class="p">,</span><span class="n">outlier_index</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">outlier_index</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">outlier_index</span><span class="p">,</span> <span class="n">para</span>

<span class="n">index</span><span class="p">,</span><span class="n">para</span> <span class="o">=</span> <span class="n">outlier_detect</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;IQR&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Upper bound:&#39;</span><span class="p">,</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Lower bound:&#39;</span><span class="p">,</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="windsorize-outliers-func">
<h3>Windsorize Outliers (func)<a class="headerlink" href="#windsorize-outliers-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">windsorization</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">para</span><span class="p">,</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    top-coding &amp; bottom coding (capping the maximum of a distribution at an arbitrarily set value,vice versa)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data_copy</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
        <span class="n">data_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">&lt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
        <span class="n">data_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;bottom&#39;</span><span class="p">:</span>
        <span class="n">data_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">&lt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data_copy</span>


<span class="n">df_out</span> <span class="o">=</span> <span class="n">windsorization</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="n">para</span><span class="o">=</span><span class="n">para</span><span class="p">,</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="drop-outliers">
<h3>Drop Outliers<a class="headerlink" href="#drop-outliers" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">## run the top two examples</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">index</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="impute-outliers">
<h3>Impute Outliers<a class="headerlink" href="#impute-outliers" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">impute_outlier</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">outlier_index</span><span class="p">,</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    impute outlier with mean/median/most frequent values of that variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data_copy</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">data_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outlier_index</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="n">data_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outlier_index</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span>
        <span class="n">data_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outlier_index</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">data_copy</span>

<span class="n">df_out</span> <span class="o">=</span> <span class="n">impute_outlier</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">outlier_index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="feature-engineering">
<h2>Feature Engineering<a class="headerlink" href="#feature-engineering" title="Permalink to this headline">¶</a></h2>
<div class="section" id="automated-dummy-one-hot-encoding-func">
<h3>Automated Dummy (one-hot) Encoding(func)<a class="headerlink" href="#automated-dummy-one-hot-encoding-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">auto_dummy</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="c1"># Creating dummies for small object uniques</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">&lt;</span><span class="n">unique</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unique is set higher than data lenght&#39;</span><span class="p">)</span>
    <span class="n">list_dummies</span> <span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">&lt;</span> <span class="n">unique</span><span class="p">):</span>
            <span class="n">list_dummies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">df_edit</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">list_dummies</span><span class="p">)</span> <span class="c1"># Saves original dataframe</span>
    <span class="c1">#df_edit = pd.concat([df[[&quot;year&quot;,&quot;qtr&quot;]],df_edit],axis=1)</span>
    <span class="k">return</span> <span class="n">df_edit</span>

<span class="n">df_out</span> <span class="o">=</span> <span class="n">auto_dummy</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="binarise-empty-columns-func">
<h3>Binarise Empty Columns (func)<a class="headerlink" href="#binarise-empty-columns-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">&gt;</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span>  <span class="o">=</span> <span class="kc">None</span>
<span class="k">def</span> <span class="nf">binarise_empty</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
<span class="c1"># Binarise slightly empty columns</span>
    <span class="n">this</span> <span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
            <span class="n">is_null</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">is_null</span><span class="o">/</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span><span class="n">frac</span><span class="p">:</span> <span class="c1"># if more than 70% is null binarise</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">this</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">this</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df_out</span> <span class="o">=</span> <span class="n">binarise_empty</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.6</span><span class="p">);</span> <span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="polynomials-func">
<h3>Polynomials (func)<a class="headerlink" href="#polynomials-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">polynomials</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feature_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">feat_two</span> <span class="ow">in</span> <span class="n">feature_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">feat</span><span class="o">==</span><span class="n">feat_two</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">feat_two</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">feat_two</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="n">feat_two</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="c1">#zero division guard</span>
                <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="o">+</span><span class="s2">&quot;X&quot;</span><span class="o">+</span><span class="n">feat_two</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">feat_two</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df_out</span> <span class="o">=</span> <span class="n">polynomials</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">])</span> <span class="p">;</span> <span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="transformations-func">
<h3>Transformations (func)<a class="headerlink" href="#transformations-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">transformations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">features</span><span class="p">):</span>
    <span class="n">df_new</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
    <span class="n">df_new</span> <span class="o">=</span> <span class="n">df_new</span> <span class="o">-</span> <span class="n">df_new</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="n">sqr_name</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_POWER_2&quot;</span> <span class="k">for</span> <span class="n">fa</span> <span class="ow">in</span> <span class="n">df_new</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">log_p_name</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_LOG_p_one_abs&quot;</span> <span class="k">for</span> <span class="n">fa</span> <span class="ow">in</span> <span class="n">df_new</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">rec_p_name</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_RECIP_p_one&quot;</span> <span class="k">for</span> <span class="n">fa</span> <span class="ow">in</span> <span class="n">df_new</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">sqrt_name</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_SQRT_p_one&quot;</span> <span class="k">for</span> <span class="n">fa</span> <span class="ow">in</span> <span class="n">df_new</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="n">df_sqr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">df_new</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span><span class="n">columns</span><span class="o">=</span><span class="n">sqr_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">df_log</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df_new</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">),</span><span class="n">columns</span><span class="o">=</span><span class="n">log_p_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">df_rec</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">df_new</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">),</span><span class="n">columns</span><span class="o">=</span><span class="n">rec_p_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">df_sqrt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_new</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">),</span><span class="n">columns</span><span class="o">=</span><span class="n">sqrt_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">,</span> <span class="n">df_sqr</span><span class="p">,</span> <span class="n">df_log</span><span class="p">,</span> <span class="n">df_rec</span><span class="p">,</span> <span class="n">df_sqrt</span><span class="p">]</span>
    <span class="n">df</span><span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df_out</span> <span class="o">=</span> <span class="n">transformations</span><span class="p">(</span><span class="n">df</span><span class="p">,[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">]);</span> <span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="genetic-programming">
<h3>Genetic Programming<a class="headerlink" href="#genetic-programming" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">gplearn.genetic</span> <span class="kn">import</span> <span class="n">SymbolicTransformer</span>
<span class="n">function_set</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;sub&#39;</span><span class="p">,</span> <span class="s1">&#39;mul&#39;</span><span class="p">,</span> <span class="s1">&#39;div&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">,</span> <span class="s1">&#39;inv&#39;</span><span class="p">,</span><span class="s1">&#39;tan&#39;</span><span class="p">]</span>

<span class="n">gp</span> <span class="o">=</span> <span class="n">SymbolicTransformer</span><span class="p">(</span><span class="n">generations</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">population_size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                        <span class="n">hall_of_fame</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">function_set</span><span class="o">=</span><span class="n">function_set</span><span class="p">,</span>
                        <span class="n">parsimony_coefficient</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
                        <span class="n">max_samples</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

<span class="n">gen_feats</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]);</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="mi">8</span><span class="p">]</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">df</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">gen_feats</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gen_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">gen_feats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span> <span class="n">df_out</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="mi">8</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="prinicipal-component-features-func">
<h3>Prinicipal Component Features (func)<a class="headerlink" href="#prinicipal-component-features-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span><span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span><span class="p">,</span> <span class="n">IncrementalPCA</span>

<span class="k">def</span> <span class="nf">pca_feature</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">memory_issues</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mem_iss_component</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">variance_or_components</span><span class="o">=</span><span class="mf">0.80</span><span class="p">,</span><span class="n">drop_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">memory_issues</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mem_iss_component</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you have memory issues, you have to preselect mem_iss_component&quot;</span><span class="p">)</span>
    <span class="n">pca</span> <span class="o">=</span> <span class="n">IncrementalPCA</span><span class="p">(</span><span class="n">mem_iss_component</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">variance_or_components</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">variance_or_components</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># automted selection based on variance</span>
            <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">variance_or_components</span><span class="p">,</span><span class="n">svd_solver</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">)</span>
    <span class="n">X_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="n">drop_cols</span><span class="p">],</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_pca</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PCA_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X_pca</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df_out</span> <span class="o">=</span><span class="n">pca_feature</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">variance_or_components</span><span class="o">=</span><span class="mf">0.80</span><span class="p">,</span><span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">,</span><span class="s2">&quot;a&quot;</span><span class="p">]);</span> <span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="multiple-lags-func">
<h3>Multiple Lags (func)<a class="headerlink" href="#multiple-lags-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">multiple_lags</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">lags</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Just two lags for demonstration.</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_t_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">lags</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df_out</span> <span class="o">=</span> <span class="n">multiple_lags</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;target&quot;</span><span class="p">]);</span> <span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="multiple-rolling-func">
<h3>Multiple Rolling (func)<a class="headerlink" href="#multiple-rolling-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">multiple_rolling</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">functions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span><span class="s2">&quot;std&quot;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">rolling_dfs</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>                                    <span class="c1"># 1. Create window</span>
                    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span>                                <span class="c1"># 1. Aggregate</span>
                    <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 2. Rename columns</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">)</span>                                <span class="c1"># For each window</span>
    <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">rolling_dfs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">df_out</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):]</span>
    <span class="n">da</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span>  <span class="n">da</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()]</span>
    <span class="n">df_out</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">+</span> <span class="n">da</span>

    <span class="k">return</span>  <span class="n">df_out</span>                      <span class="c1"># 3. Concatenate dataframes</span>

<span class="n">df_out</span> <span class="o">=</span> <span class="n">multiple_rolling</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">])</span>
<span class="n">df_out</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="date-features">
<h3>Date Features<a class="headerlink" href="#date-features" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;date_fake&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;2019-01-03&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;2019-01-06&quot;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">date_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">):</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="o">+</span><span class="s2">&quot;_month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="o">+</span><span class="s2">&quot;_year&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="o">+</span><span class="s2">&quot;_week&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">week</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="o">+</span><span class="s2">&quot;_day&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="o">+</span><span class="s2">&quot;_dayofweek&quot;</span><span class="p">]</span><span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofweek</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="o">+</span><span class="s2">&quot;_dayofyear&quot;</span><span class="p">]</span><span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="o">+</span><span class="s2">&quot;_hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="o">+</span><span class="s2">&quot;_int&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df_out</span> <span class="o">=</span> <span class="n">date_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="s2">&quot;date_fake&quot;</span><span class="p">);</span> <span class="n">df_out</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="mi">8</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="haversine-distance-location-feature-func">
<h3>Haversine Distance (Location Feature) (func)<a class="headerlink" href="#haversine-distance-location-feature-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">39</span><span class="p">,</span> <span class="mi">35</span> <span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">=</span>  <span class="p">[</span><span class="o">-</span><span class="mi">77</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span> <span class="p">,</span> <span class="o">-</span><span class="mi">10</span> <span class="p">]</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">atan2</span><span class="p">,</span> <span class="n">radians</span>
<span class="k">def</span> <span class="nf">haversine_distance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="s2">&quot;longitude&quot;</span><span class="p">):</span>
    <span class="n">c_lat</span><span class="p">,</span><span class="n">c_long</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="mf">52.5200</span><span class="p">),</span> <span class="n">radians</span><span class="p">(</span><span class="mf">13.4050</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mf">6373.0</span>
    <span class="n">long</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">])</span>

    <span class="n">dlon</span> <span class="o">=</span> <span class="n">long</span> <span class="o">-</span> <span class="n">c_long</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="n">lat</span> <span class="o">-</span> <span class="n">c_lat</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">dlat</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">c_lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">dlon</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">atan2</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">R</span> <span class="o">*</span> <span class="n">c</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;distance_central&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">haversine_distance</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">4</span><span class="p">:]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="parse-address">
<h3>Parse Address<a class="headerlink" href="#parse-address" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;addr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span>
            <span class="s1">&#39;Washington, D.C. 20003&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Brooklyn, NY 11211-1755&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Omaha, NE 68154&#39;</span> <span class="p">])</span>
<span class="n">regex</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?P&lt;city&gt;[A-Za-z ]+), (?P&lt;state&gt;[A-Z]</span><span class="si">{2}</span><span class="s1">) (?P&lt;zip&gt;\d</span><span class="si">{5}</span><span class="s1">(?:-\d</span><span class="si">{4}</span><span class="s1">)?)&#39;</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">addr</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="processing-strings-in-pandas">
<h3>Processing Strings in Pandas<a class="headerlink" href="#processing-strings-in-pandas" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">makeMixedDataFrame</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span>


<span class="sd">&quot;&quot;&quot;convert column to UPPERCASE&quot;&quot;&quot;</span>

<span class="n">col_name</span> <span class="o">=</span> <span class="s2">&quot;C&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

<span class="sd">&quot;&quot;&quot;count string occurence in each row&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d&#39;</span><span class="p">)</span> <span class="c1"># counts number of digits</span>

<span class="sd">&quot;&quot;&quot;count # o chars in each row&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;o&#39;</span><span class="p">)</span> <span class="c1"># counts number of digits</span>

<span class="sd">&quot;&quot;&quot;split rows&quot;&quot;&quot;</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s2">&quot;this is a regular sentence&quot;</span><span class="p">,</span> <span class="s2">&quot;https://docs.p.org&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
<span class="n">s</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="sd">&quot;&quot;&quot;this creates new columns with the different split values (instead of lists)&quot;&quot;&quot;</span>
<span class="n">s</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;limit the number of splits to 1, and start spliting from the rights side&quot;&quot;&quot;</span>
<span class="n">s</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="filtering-strings-in-pandas">
<h3>Filtering Strings in Pandas<a class="headerlink" href="#filtering-strings-in-pandas" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">makeMixedDataFrame</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span>
<span class="n">col_name</span> <span class="o">=</span> <span class="s2">&quot;C&quot;</span>

<span class="sd">&quot;&quot;&quot;check if a certain word/pattern occurs in each row&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;oo&#39;</span><span class="p">)</span>  <span class="c1"># returns True/False for each row</span>

<span class="sd">&quot;&quot;&quot;find occurences&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[ABC]\d&#39;</span><span class="p">)</span> <span class="c1"># returns a list of the found occurences of the specified pattern for each row</span>

<span class="sd">&quot;&quot;&quot;replace Weekdays by abbrevations (e.g. Monday --&gt; Mon)&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+day\b)&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span> <span class="c1"># () in r&#39;&#39; creates a group with one element, which we acces with x.groups[0]</span>

<span class="sd">&quot;&quot;&quot;create dataframe from regex groups (str.extract() uses first match of the pattern only)&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d?\d):(\d\d)&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?P&lt;hours&gt;\d?\d):(?P&lt;minutes&gt;\d\d)&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?P&lt;time&gt;(?P&lt;hours&gt;\d?\d):(?P&lt;minutes&gt;\d\d))&#39;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;if you want to take into account ALL matches in a row (not only first one):&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d?\d):(\d\d)&#39;</span><span class="p">)</span> <span class="c1"># this generates a multiindex with level 1 = &#39;match&#39;, indicating the order of the match</span>

<span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;remove all the characters after &amp;# (including &amp;#) for column - col_1&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &amp;#.*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;remove white space at the beginning of string&quot;&quot;&quot;</span>
<span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="model-validation">
<h2>Model Validation<a class="headerlink" href="#model-validation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="classification-metrics-func">
<h3>Classification Metrics (func)<a class="headerlink" href="#classification-metrics-func" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">y_test</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">y_predict</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">y_prob</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.9</span><span class="p">]</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">average_precision_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">log_loss</span><span class="p">,</span> <span class="n">brier_score_loss</span><span class="p">,</span> <span class="n">accuracy_score</span>

<span class="k">def</span> <span class="nf">classification_scores</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_predict</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">):</span>

    <span class="n">confusion_mat</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_predict</span><span class="p">)</span>

    <span class="n">TN</span> <span class="o">=</span> <span class="n">confusion_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">FP</span> <span class="o">=</span> <span class="n">confusion_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">TP</span> <span class="o">=</span> <span class="n">confusion_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">FN</span> <span class="o">=</span> <span class="n">confusion_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">TPR</span> <span class="o">=</span> <span class="n">TP</span><span class="o">/</span><span class="p">(</span><span class="n">TP</span><span class="o">+</span><span class="n">FN</span><span class="p">)</span>
    <span class="c1"># Specificity or true negative rate</span>
    <span class="n">TNR</span> <span class="o">=</span> <span class="n">TN</span><span class="o">/</span><span class="p">(</span><span class="n">TN</span><span class="o">+</span><span class="n">FP</span><span class="p">)</span>
    <span class="c1"># Precision or positive predictive value</span>
    <span class="n">PPV</span> <span class="o">=</span> <span class="n">TP</span><span class="o">/</span><span class="p">(</span><span class="n">TP</span><span class="o">+</span><span class="n">FP</span><span class="p">)</span>
    <span class="c1"># Negative predictive value</span>
    <span class="n">NPV</span> <span class="o">=</span> <span class="n">TN</span><span class="o">/</span><span class="p">(</span><span class="n">TN</span><span class="o">+</span><span class="n">FN</span><span class="p">)</span>
    <span class="c1"># Fall out or false positive rate</span>
    <span class="n">FPR</span> <span class="o">=</span> <span class="n">FP</span><span class="o">/</span><span class="p">(</span><span class="n">FP</span><span class="o">+</span><span class="n">TN</span><span class="p">)</span>
    <span class="c1"># False negative rate</span>
    <span class="n">FNR</span> <span class="o">=</span> <span class="n">FN</span><span class="o">/</span><span class="p">(</span><span class="n">TP</span><span class="o">+</span><span class="n">FN</span><span class="p">)</span>
    <span class="c1"># False discovery rate</span>
    <span class="n">FDR</span> <span class="o">=</span> <span class="n">FP</span><span class="o">/</span><span class="p">(</span><span class="n">TP</span><span class="o">+</span><span class="n">FP</span><span class="p">)</span>

    <span class="n">ll</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span> <span class="c1"># Its low but means nothing to me.</span>
    <span class="n">br</span> <span class="o">=</span> <span class="n">brier_score_loss</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span> <span class="c1"># Its low but means nothing to me.</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_predict</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
    <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span>
    <span class="n">prc</span> <span class="o">=</span> <span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">df_exec</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Average Log Likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ll</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Brier Score Loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">br</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Accuracy Score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;ROC AUC Sore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auc</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Average Precision Score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prc</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Precision - Bankrupt Firms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PPV</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;False Positive Rate (p-value)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPR</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Precision - Healthy Firms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NPV</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;False Negative Rate (recall error)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FNR</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;False Discovery Rate &quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FDR</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;All Observations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TN</span> <span class="o">+</span> <span class="n">TP</span> <span class="o">+</span> <span class="n">FN</span> <span class="o">+</span> <span class="n">FP</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Bankruptcy Sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TP</span> <span class="o">+</span> <span class="n">FN</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Healthy Sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TN</span> <span class="o">+</span> <span class="n">FP</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Recalled Bankruptcy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TP</span> <span class="o">+</span> <span class="n">FP</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Correct (True Positives)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TP</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Incorrect (False Positives)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FP</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Recalled Healthy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TN</span> <span class="o">+</span> <span class="n">FN</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Correct (True Negatives)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TN</span>
    <span class="n">df_exec</span><span class="p">[</span><span class="s2">&quot;Incorrect (False Negatives)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FN</span>

    <span class="n">df_exec</span> <span class="o">=</span> <span class="n">df_exec</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">df_exec</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Metrics&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df_exec</span>


<span class="n">met</span> <span class="o">=</span> <span class="n">classification_scores</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_predict</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">);</span> <span class="n">met</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Snippet/python.html" class="btn btn-neutral float-right" title="Python" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="50_plots.html" class="btn btn-neutral float-left" title="Scientific Plots" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, AdamZhou

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>